<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZX Spectrum TOSEC Organizer</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: system-ui, sans-serif; }
        .drag-over { background: rgba(34, 197, 94, 0.3) !important; border: 2px dashed #22c55e !important; }
        .file-row { cursor: grab; user-select: none; }
        .file-row:active { cursor: grabbing; }
        .file-row.dragging { opacity: 0.4; background: rgba(139, 92, 246, 0.3) !important; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_BASE = 'http://localhost:5000/api';

        const EMULABLE_EXT = ['.tap', '.tzx', '.z80', '.sna', '.dsk', '.trd', '.scl'];
        const OPENABLE_EXT = ['.pdf', '.jpg', '.jpeg', '.png', '.gif', '.bmp', '.txt', '.doc', '.docx'];

        const Icon = ({ name, className = "w-5 h-5" }) => {
            const icons = {
                folder: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>,
                file: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>,
                terminal: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
                refresh: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
                check: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
                zap: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
                loader: <svg className={`${className} animate-spin`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
                settings: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
                trash: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
                plus: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
                x: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
                copy: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
                search: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
                play: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
                open: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
            };
            return icons[name] || icons.folder;
        };

        function App() {
            const [activeTab, setActiveTab] = useState('explorer');
            const [feStructure, setFeStructure] = useState(null);
            const [tsStructure, setTsStructure] = useState(null);
            
            const [fePath, setFePath] = useState([]);
            const [feItems, setFeItems] = useState([]);
            const [feLoading, setFeLoading] = useState(false);
            
            const [tsPath, setTsPath] = useState([]);
            const [tsItems, setTsItems] = useState([]);
            const [tsLoading, setTsLoading] = useState(false);
            
            const [tempFiles, setTempFiles] = useState([]);
            const [rules, setRules] = useState([]);
            const [error, setError] = useState(null);
            const [success, setSuccess] = useState(null);
            const [copyLog, setCopyLog] = useState([]);
            
            // Drag state guardado en ref para acceso inmediato
            const dragDataRef = useRef(null);
            const [isDragging, setIsDragging] = useState(false);
            
            const [showProcessModal, setShowProcessModal] = useState(false);
            const [selectedFile, setSelectedFile] = useState(null);
            const [selectedDestinations, setSelectedDestinations] = useState({ FE: [], TS: [] });
            const [processing, setProcessing] = useState(false);
            
            const [showFolderBrowser, setShowFolderBrowser] = useState(false);
            const [browserPath, setBrowserPath] = useState([]);
            const [browserFolders, setBrowserFolders] = useState([]);
            const [browserCollection, setBrowserCollection] = useState('FE');
            const [currentRuleIndex, setCurrentRuleIndex] = useState(null);
            
            const [showFileBrowser, setShowFileBrowser] = useState(false);
            const [fileBrowserCollection, setFileBrowserCollection] = useState('TEMP');
            const [fileBrowserPath, setFileBrowserPath] = useState([]);
            const [fileBrowserItems, setFileBrowserItems] = useState([]);
            const [fileSearchFilter, setFileSearchFilter] = useState('');
            
            const [ruleSearchFilter, setRuleSearchFilter] = useState('');
            
            // Emulador
            const [emulatorFile, setEmulatorFile] = useState(null);

            useEffect(() => { loadStructures(); }, []);

            const loadStructures = async () => {
                try {
                    const [feRes, tsRes] = await Promise.all([
                        fetch(`${API_BASE}/scan/FE`),
                        fetch(`${API_BASE}/scan/TS`)
                    ]);
                    setFeStructure(await feRes.json());
                    setTsStructure(await tsRes.json());
                } catch (err) {
                    setError('Error cargando estructuras');
                }
            };

            const loadPanelContents = async (collection, pathArray, setItems, setLoading) => {
                setLoading(true);
                try {
                    const pathStr = pathArray.join('/');
                    const response = await fetch(`${API_BASE}/browse/${collection}/${encodeURIComponent(pathStr)}`);
                    const data = await response.json();
                    setItems(data.error ? [] : (data.items || []));
                    if (data.error) setError(data.error);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const loadTempFiles = async () => {
                try {
                    const response = await fetch(`${API_BASE}/temp/scan`);
                    const data = await response.json();
                    setTempFiles(data.files || []);
                } catch (err) { setError(err.message); }
            };

            const loadRules = async () => {
                try {
                    const response = await fetch(`${API_BASE}/rules/load`);
                    const data = await response.json();
                    setRules(data.rules || []);
                } catch (err) { setError(err.message); }
            };

            const saveRules = async () => {
                try {
                    const response = await fetch(`${API_BASE}/rules/save`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ rules })
                    });
                    const data = await response.json();
                    if (data.success) setSuccess('Reglas guardadas');
                    else setError(data.error);
                } catch (err) { setError(err.message); }
            };

            // Abrir archivo (PDF, imágenes, etc.)
            const openFile = async (filePath) => {
                try {
                    const response = await fetch(`${API_BASE}/open-file`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path: filePath })
                    });
                    const data = await response.json();
                    if (!data.success) setError(data.error);
                } catch (err) { setError(err.message); }
            };

            // Cargar en emulador - abre JSSpeccy en nueva ventana con el archivo
            const loadInEmulator = async (filePath, fileName) => {
                setEmulatorFile({ path: filePath, name: fileName, loading: true });
                setSuccess(`Cargando ${fileName} en emulador...`);
                
                // Usamos JSSpeccy online que permite cargar via URL
                // Primero obtenemos el archivo en base64
                try {
                    const response = await fetch(`${API_BASE}/file-base64`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path: filePath })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        // Crear un blob y abrirlo con el emulador local
                        const binary = atob(data.base64);
                        const bytes = new Uint8Array(binary.length);
                        for (let i = 0; i < binary.length; i++) {
                            bytes[i] = binary.charCodeAt(i);
                        }
                        const blob = new Blob([bytes], { type: 'application/octet-stream' });
                        const url = URL.createObjectURL(blob);
                        
                        // Abrir JSSpeccy con el archivo
                        // JSSpeccy3 permite cargar archivos via hash URL
                        const emulatorUrl = `https://nicofirst.github.io/web-zxspectrum/?file=${encodeURIComponent(url)}`;
                        
                        // Alternativa: abrir en nueva ventana con Qaop que permite drag&drop
                        window.open(`https://torinak.com/qaop`, '_blank');
                        
                        setEmulatorFile({ ...data, url, loading: false });
                        setSuccess(`${fileName} listo. Arrastra el archivo descargado al emulador o usa Ctrl+O`);
                        
                        // Descargar el archivo automáticamente para que el usuario pueda arrastrarlo
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        a.click();
                    } else {
                        setError(data.error);
                    }
                } catch (err) {
                    setError(err.message);
                }
            };

            // DRAG & DROP - Simplificado y robusto
            const handleDragStart = (e, item, sourceCollection) => {
                if (item.type !== 'file') {
                    e.preventDefault();
                    return;
                }
                
                // Guardar datos en ref (acceso síncrono) y en dataTransfer
                const data = { item, sourceCollection };
                dragDataRef.current = data;
                setIsDragging(true);
                
                e.dataTransfer.effectAllowed = 'copy';
                e.dataTransfer.setData('application/json', JSON.stringify(data));
                
                // Efecto visual
                e.currentTarget.classList.add('dragging');
            };

            const handleDragEnd = (e) => {
                e.currentTarget.classList.remove('dragging');
                dragDataRef.current = null;
                setIsDragging(false);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'copy';
            };

            const handleDragEnter = (e) => {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.add('drag-over');
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                e.stopPropagation();
                // Solo quitar clase si realmente salimos del contenedor
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX;
                const y = e.clientY;
                if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                    e.currentTarget.classList.remove('drag-over');
                }
            };

            const handleDrop = async (e, destCollection, destPath) => {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.remove('drag-over');
                
                // Intentar obtener datos de múltiples fuentes
                let dragData = dragDataRef.current;
                
                if (!dragData) {
                    try {
                        const jsonData = e.dataTransfer.getData('application/json');
                        if (jsonData) {
                            dragData = JSON.parse(jsonData);
                        }
                    } catch (err) {
                        console.error('Error parsing drag data', err);
                    }
                }
                
                if (!dragData) {
                    setError('No se pudo obtener información del archivo');
                    return;
                }
                
                const { item, sourceCollection } = dragData;
                
                // No copiar al mismo panel
                if (sourceCollection === destCollection) {
                    dragDataRef.current = null;
                    setIsDragging(false);
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/copy-between`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            source_path: item.full_path,
                            dest_collection: destCollection,
                            dest_folder: destPath.join('/')
                        })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        setCopyLog(prev => [{
                            time: new Date().toLocaleTimeString(),
                            file: item.name,
                            from: sourceCollection,
                            to: destCollection,
                            dest: destPath.join('/') || '(raíz)'
                        }, ...prev.slice(0, 49)]);
                        setSuccess(`✓ ${item.name} → ${destCollection}:/${destPath.join('/')}`);
                        
                        // Recargar panel destino
                        if (destCollection === 'FE' && fePath.length > 0) loadPanelContents('FE', fePath, setFeItems, setFeLoading);
                        if (destCollection === 'TS' && tsPath.length > 0) loadPanelContents('TS', tsPath, setTsItems, setTsLoading);
                    } else {
                        setError(data.error || 'Error al copiar');
                    }
                } catch (err) {
                    setError(`Error: ${err.message}`);
                }
                
                dragDataRef.current = null;
                setIsDragging(false);
            };

            // Navegación
            const clickFolderFE = (f) => { const np = [...fePath, f.name]; setFePath(np); loadPanelContents('FE', np, setFeItems, setFeLoading); };
            const clickRootFE = (f) => { setFePath([f.name]); loadPanelContents('FE', [f.name], setFeItems, setFeLoading); };
            const breadcrumbFE = (i) => { if (i === -1) { setFePath([]); setFeItems([]); } else { const np = fePath.slice(0, i + 1); setFePath(np); loadPanelContents('FE', np, setFeItems, setFeLoading); } };
            const refreshFE = () => { if (fePath.length > 0) loadPanelContents('FE', fePath, setFeItems, setFeLoading); loadStructures(); };

            const clickFolderTS = (f) => { const np = [...tsPath, f.name]; setTsPath(np); loadPanelContents('TS', np, setTsItems, setTsLoading); };
            const clickRootTS = (f) => { setTsPath([f.name]); loadPanelContents('TS', [f.name], setTsItems, setTsLoading); };
            const breadcrumbTS = (i) => { if (i === -1) { setTsPath([]); setTsItems([]); } else { const np = tsPath.slice(0, i + 1); setTsPath(np); loadPanelContents('TS', np, setTsItems, setTsLoading); } };
            const refreshTS = () => { if (tsPath.length > 0) loadPanelContents('TS', tsPath, setTsItems, setTsLoading); loadStructures(); };

            // Helpers
            const getFileExt = (name) => { const i = name.lastIndexOf('.'); return i > 0 ? name.substring(i).toLowerCase() : ''; };
            const isEmulable = (name) => EMULABLE_EXT.includes(getFileExt(name));
            const isOpenable = (name) => OPENABLE_EXT.includes(getFileExt(name));

            // Reglas
            const deleteRule = (i) => { if (confirm('¿Eliminar?')) { setRules(rules.filter((_, idx) => idx !== i)); } };
            const addRule = () => setRules([...rules, { files: [], categories: [] }]);
            const addFileToRule = (ri) => { const nr = [...rules]; nr[ri].files.push(''); setRules(nr); };
            const updateFileInRule = (ri, fi, v) => { const nr = [...rules]; nr[ri].files[fi] = v; setRules(nr); };
            const removeFileFromRule = (ri, fi) => { const nr = [...rules]; nr[ri].files.splice(fi, 1); setRules(nr); };
            const addCategoryToRule = (ri) => { const nr = [...rules]; nr[ri].categories.push(''); setRules(nr); };
            const updateCategoryInRule = (ri, ci, v) => { const nr = [...rules]; nr[ri].categories[ci] = v; setRules(nr); };
            const removeCategoryFromRule = (ri, ci) => { const nr = [...rules]; nr[ri].categories.splice(ci, 1); setRules(nr); };

            const openFolderBrowser = (ri) => { setCurrentRuleIndex(ri); setBrowserPath([]); setBrowserCollection('FE'); loadBrowserFolders('FE', ''); setShowFolderBrowser(true); };
            const loadBrowserFolders = async (c, p) => { const url = p ? `${API_BASE}/browse-folders/${c}/${encodeURIComponent(p)}` : `${API_BASE}/browse-folders/${c}`; const r = await fetch(url); const d = await r.json(); setBrowserFolders(d.folders || []); };
            const selectFolderForRule = () => { if (currentRuleIndex === null) return; const fp = `${browserCollection}:${browserPath.join('/')}`; const nr = [...rules]; if (!nr[currentRuleIndex].categories.includes(fp)) { nr[currentRuleIndex].categories.push(fp); setRules(nr); } setShowFolderBrowser(false); };

            const openFileBrowserForRule = (ri) => { setCurrentRuleIndex(ri); setFileBrowserCollection('TEMP'); setFileBrowserPath([]); setFileSearchFilter(''); loadFileBrowserContents('TEMP', []); setShowFileBrowser(true); };
            const loadFileBrowserContents = async (c, p) => { if (c === 'TEMP') { const r = await fetch(`${API_BASE}/temp/scan`); const d = await r.json(); setFileBrowserItems((d.files || []).map(f => ({ ...f, type: 'file' }))); } else { const ps = p.join('/'); const url = ps ? `${API_BASE}/browse/${c}/${encodeURIComponent(ps)}` : `${API_BASE}/scan/${c}`; const r = await fetch(url); const d = await r.json(); setFileBrowserItems(d.folders ? d.folders.map(f => ({ ...f, type: 'folder' })) : d.items || []); } };
            const selectFileForRule = (f) => { if (currentRuleIndex === null) return; const nr = [...rules]; if (!nr[currentRuleIndex].files.includes(f.name)) { nr[currentRuleIndex].files.push(f.name); setRules(nr); } setShowFileBrowser(false); };

            // TEMP
            const deleteTempFile = async (fn) => { if (!confirm(`¿Eliminar ${fn}?`)) return; await fetch(`${API_BASE}/temp/delete`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ filename: fn }) }); loadTempFiles(); };
            const openProcessModal = (f) => { setSelectedFile(f); setSelectedDestinations({ FE: f.suggested_paths?.FE || [], TS: f.suggested_paths?.TS || [] }); setShowProcessModal(true); };
            const processFile = async () => { if (!selectedFile) return; setProcessing(true); const r = await fetch(`${API_BASE}/process-file`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ filename: selectedFile.name, destinations: selectedDestinations }) }); const d = await r.json(); setProcessing(false); if (d.overall_success) { setSuccess(`Copiado a ${d.FE.success.length + d.TS.success.length} destinos`); setShowProcessModal(false); loadTempFiles(); } };
            const toggleDestination = (c, p) => { setSelectedDestinations(prev => { const l = prev[c] || []; return l.includes(p) ? { ...prev, [c]: l.filter(x => x !== p) } : { ...prev, [c]: [...l, p] }; }); };

            const filteredRules = rules.filter(r => { if (!ruleSearchFilter) return true; const s = ruleSearchFilter.toLowerCase(); return r.files.some(f => f.toLowerCase().includes(s)) || r.categories.some(c => c.toLowerCase().includes(s)); });

            const panelHeight = 'calc((100vh - 130px) / 3)';

            // Componente FileRow - toda la fila es draggable
            const FileRow = ({ item, collection, onFolderClick }) => {
                const canEmulate = item.type === 'file' && isEmulable(item.name);
                const canOpen = item.type === 'file' && isOpenable(item.name);
                
                const handleClick = (e) => {
                    if (item.type === 'folder') {
                        onFolderClick(item);
                    }
                };
                
                const handleEmulatorClick = (e) => {
                    e.stopPropagation();
                    loadInEmulator(item.full_path, item.name);
                };
                
                const handleOpenClick = (e) => {
                    e.stopPropagation();
                    openFile(item.full_path);
                };
                
                if (item.type === 'folder') {
                    return (
                        <div onClick={handleClick} className="p-1.5 rounded border text-xs flex items-center gap-1.5 cursor-pointer bg-gray-800/50 border-gray-700/50 hover:border-cyan-500/50 hover:bg-gray-700/50">
                            <Icon name="folder" className="w-3.5 h-3.5 flex-shrink-0 text-cyan-400" />
                            <span className="flex-1 truncate">{item.name}</span>
                            <span className="text-purple-400">{item.file_count?.toLocaleString()}</span>
                        </div>
                    );
                }
                
                return (
                    <div 
                        draggable="true"
                        onDragStart={(e) => handleDragStart(e, item, collection)}
                        onDragEnd={handleDragEnd}
                        className="file-row p-1.5 rounded border text-xs flex items-center gap-1.5 bg-gray-800/50 border-gray-700/50 hover:border-purple-500/50 hover:bg-gray-700/50"
                    >
                        <Icon name="file" className={`w-3.5 h-3.5 flex-shrink-0 ${canEmulate ? 'text-green-400' : canOpen ? 'text-orange-400' : 'text-gray-400'}`} />
                        <span className="flex-1 truncate" title={item.name}>{item.name}</span>
                        <span className="text-gray-500 text-xs">{(item.size/1024).toFixed(0)}K</span>
                        {canEmulate && (
                            <button onClick={handleEmulatorClick} className="p-1 bg-green-600 hover:bg-green-500 rounded flex-shrink-0" title="Cargar en emulador">
                                <Icon name="play" className="w-3 h-3" />
                            </button>
                        )}
                        {canOpen && (
                            <button onClick={handleOpenClick} className="p-1 bg-orange-600 hover:bg-orange-500 rounded flex-shrink-0" title="Abrir">
                                <Icon name="open" className="w-3 h-3" />
                            </button>
                        )}
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 text-white">
                    {/* HEADER */}
                    <header className="border-b border-purple-500/30 bg-black/30 px-3 py-1.5">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="w-7 h-7 bg-gradient-to-br from-cyan-400 to-purple-500 rounded flex items-center justify-center">
                                    <Icon name="terminal" className="w-4 h-4" />
                                </div>
                                <span className="font-bold text-sm">ZX TOSEC Organizer</span>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="flex gap-2 text-xs">
                                    <span className="text-gray-400">FE: <span className="text-blue-400">{feStructure?.total_files?.toLocaleString()}</span></span>
                                    <span className="text-gray-400">TS: <span className="text-cyan-400">{tsStructure?.total_files?.toLocaleString()}</span></span>
                                    <span className="text-gray-400">TEMP: <span className="text-yellow-400">{tempFiles.length}</span></span>
                                </div>
                                <div className="flex gap-1">
                                    {['explorer', 'temp', 'rules', 'log'].map(tab => (
                                        <button key={tab} onClick={() => { setActiveTab(tab); if (tab === 'temp') loadTempFiles(); if (tab === 'rules') loadRules(); }}
                                            className={`px-2 py-1 rounded text-xs ${activeTab === tab ? 'bg-purple-600' : 'bg-gray-800 hover:bg-gray-700'}`}>
                                            {tab === 'explorer' ? 'Explorador' : tab === 'temp' ? 'TEMP' : tab === 'rules' ? 'Reglas' : `Log (${copyLog.length})`}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Alertas */}
                    {error && <div className="mx-3 mt-1 p-1.5 bg-red-500/20 border border-red-500/50 rounded text-xs flex justify-between items-center"><span>{error}</span><button onClick={() => setError(null)} className="ml-2">✕</button></div>}
                    {success && <div className="mx-3 mt-1 p-1.5 bg-green-500/20 border border-green-500/50 rounded text-xs flex justify-between items-center"><span>{success}</span><button onClick={() => setSuccess(null)} className="ml-2">✕</button></div>}

                    {/* CONTENIDO */}
                    <div className="p-2" style={{height: 'calc(100vh - 50px)'}}>
                        {activeTab === 'explorer' && (
                            <div className="h-full flex gap-2">
                                {/* PANEL IZQUIERDO */}
                                <div className="w-96 flex flex-col gap-2">
                                    {/* FE Menu */}
                                    <div className="bg-black/40 border border-blue-500/30 rounded p-2 overflow-hidden" style={{height: panelHeight}}>
                                        <div className="flex items-center gap-1 mb-1">
                                            <Icon name="folder" className="w-3 h-3 text-blue-400" />
                                            <span className="text-xs font-bold text-blue-400">FE</span>
                                            <span className="text-xs text-gray-400 ml-auto">{feStructure?.total_files?.toLocaleString()}</span>
                                        </div>
                                        <div className="overflow-y-auto" style={{height: 'calc(100% - 20px)'}}>
                                            {feStructure?.folders?.map((f, i) => (
                                                <button key={i} onClick={() => clickRootFE(f)} className={`w-full text-left px-1 py-0.5 rounded text-xs hover:bg-blue-500/20 flex justify-between ${fePath[0] === f.name ? 'bg-blue-500/30' : ''}`}>
                                                    <span className="truncate">{f.name}</span>
                                                    <span className="text-purple-400 ml-1">{f.file_count?.toLocaleString()}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* TS Menu */}
                                    <div className="bg-black/40 border border-cyan-500/30 rounded p-2 overflow-hidden" style={{height: panelHeight}}>
                                        <div className="flex items-center gap-1 mb-1">
                                            <Icon name="folder" className="w-3 h-3 text-cyan-400" />
                                            <span className="text-xs font-bold text-cyan-400">TS</span>
                                            <span className="text-xs text-gray-400 ml-auto">{tsStructure?.total_files?.toLocaleString()}</span>
                                        </div>
                                        <div className="overflow-y-auto" style={{height: 'calc(100% - 20px)'}}>
                                            {tsStructure?.folders?.map((f, i) => (
                                                <button key={i} onClick={() => clickRootTS(f)} className={`w-full text-left px-1 py-0.5 rounded text-xs hover:bg-cyan-500/20 flex justify-between ${tsPath[0] === f.name ? 'bg-cyan-500/30' : ''}`}>
                                                    <span className="truncate">{f.name}</span>
                                                    <span className="text-purple-400 ml-1">{f.file_count?.toLocaleString()}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* Emulador */}
                                    <div className="bg-black/40 border border-green-500/30 rounded overflow-hidden" style={{height: panelHeight}}>
                                        <div className="px-2 py-1 flex items-center gap-1 border-b border-gray-700 bg-green-900/20">
                                            <Icon name="play" className="w-3 h-3 text-green-400" />
                                            <span className="text-xs font-bold text-green-400">Emulador Qaop</span>
                                            <a href="https://torinak.com/qaop" target="_blank" className="ml-auto text-xs text-gray-400 hover:text-white">↗ Abrir</a>
                                        </div>
                                        <iframe src="https://torinak.com/qaop#128" className="w-full border-0" style={{height: 'calc(100% - 24px)'}} allow="autoplay" title="Emulator" />
                                    </div>
                                </div>

                                {/* PANEL DERECHO - Dual */}
                                <div className="flex-1 flex bg-black/40 border border-purple-500/20 rounded overflow-hidden">
                                    {/* FE Content */}
                                    <div 
                                        className="flex-1 flex flex-col border-r border-purple-500/20"
                                        onDragOver={handleDragOver}
                                        onDragEnter={handleDragEnter}
                                        onDragLeave={handleDragLeave}
                                        onDrop={(e) => handleDrop(e, 'FE', fePath)}
                                    >
                                        <div className="px-2 py-1 bg-blue-900/30 border-b border-purple-500/20 flex items-center gap-1 text-xs">
                                            <button onClick={() => breadcrumbFE(-1)} className="font-bold text-blue-400">FE</button>
                                            {fePath.map((s, i) => (<React.Fragment key={i}><span className="text-gray-600">/</span><button onClick={() => breadcrumbFE(i)} className="text-purple-400 hover:text-purple-300 truncate max-w-20">{s}</button></React.Fragment>))}
                                            {feItems.length > 0 && <span className="text-yellow-400 font-bold">({feItems.length})</span>}
                                            <button onClick={refreshFE} className="ml-auto p-0.5 hover:bg-gray-700 rounded" title="Refrescar"><Icon name="refresh" className="w-3 h-3 text-gray-400" /></button>
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-1">
                                            {feLoading ? <div className="flex items-center justify-center h-full"><Icon name="loader" className="w-5 h-5 text-blue-400" /></div>
                                            : fePath.length === 0 ? <div className="text-center text-gray-500 py-8 text-xs">Selecciona carpeta FE ←</div>
                                            : <div className="space-y-0.5">{feItems.map((item, idx) => <FileRow key={idx} item={item} collection="FE" onFolderClick={clickFolderFE} />)}</div>}
                                        </div>
                                    </div>
                                    
                                    {/* TS Content */}
                                    <div 
                                        className="flex-1 flex flex-col"
                                        onDragOver={handleDragOver}
                                        onDragEnter={handleDragEnter}
                                        onDragLeave={handleDragLeave}
                                        onDrop={(e) => handleDrop(e, 'TS', tsPath)}
                                    >
                                        <div className="px-2 py-1 bg-cyan-900/30 border-b border-purple-500/20 flex items-center gap-1 text-xs">
                                            <button onClick={() => breadcrumbTS(-1)} className="font-bold text-cyan-400">TS</button>
                                            {tsPath.map((s, i) => (<React.Fragment key={i}><span className="text-gray-600">/</span><button onClick={() => breadcrumbTS(i)} className="text-purple-400 hover:text-purple-300 truncate max-w-20">{s}</button></React.Fragment>))}
                                            {tsItems.length > 0 && <span className="text-yellow-400 font-bold">({tsItems.length})</span>}
                                            <button onClick={refreshTS} className="ml-auto p-0.5 hover:bg-gray-700 rounded" title="Refrescar"><Icon name="refresh" className="w-3 h-3 text-gray-400" /></button>
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-1">
                                            {tsLoading ? <div className="flex items-center justify-center h-full"><Icon name="loader" className="w-5 h-5 text-cyan-400" /></div>
                                            : tsPath.length === 0 ? <div className="text-center text-gray-500 py-8 text-xs">Selecciona carpeta TS ←</div>
                                            : <div className="space-y-0.5">{tsItems.map((item, idx) => <FileRow key={idx} item={item} collection="TS" onFolderClick={clickFolderTS} />)}</div>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'temp' && (
                            <div className="h-full overflow-auto bg-black/30 border border-purple-500/30 rounded p-3">
                                <div className="flex justify-between items-center mb-3">
                                    <h2 className="font-bold flex items-center gap-2"><Icon name="zap" className="w-4 h-4 text-yellow-400" />TEMP ({tempFiles.length})</h2>
                                    <button onClick={loadTempFiles} className="px-2 py-1 bg-purple-600 rounded text-xs"><Icon name="refresh" className="w-3 h-3" /></button>
                                </div>
                                <div className="space-y-1">
                                    {tempFiles.map((f, i) => (
                                        <div key={i} className="p-2 bg-gray-800/50 border border-gray-700/50 rounded text-xs flex items-center gap-2">
                                            <Icon name="file" className={`w-4 h-4 ${isEmulable(f.name) ? 'text-green-400' : 'text-cyan-400'}`} />
                                            <div className="flex-1 min-w-0"><p className="truncate font-medium">{f.name}</p><p className="text-gray-400">{f.file_type} • {(f.size/1024).toFixed(1)}KB</p></div>
                                            {isEmulable(f.name) && <button onClick={() => loadInEmulator(f.full_path, f.name)} className="px-2 py-1 bg-green-600 rounded" title="Emulador"><Icon name="play" className="w-3 h-3" /></button>}
                                            <button onClick={() => openProcessModal(f)} className="px-2 py-1 bg-blue-600 rounded" title="Copiar"><Icon name="copy" className="w-3 h-3" /></button>
                                            <button onClick={() => deleteTempFile(f.name)} className="px-2 py-1 bg-red-600 rounded" title="Eliminar"><Icon name="trash" className="w-3 h-3" /></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'rules' && (
                            <div className="h-full overflow-hidden flex flex-col bg-black/30 border border-purple-500/30 rounded p-3">
                                <div className="flex justify-between items-center mb-2">
                                    <h2 className="font-bold flex items-center gap-2"><Icon name="settings" className="w-4 h-4 text-cyan-400" />Reglas ({rules.length})</h2>
                                    <div className="flex gap-1">
                                        <button onClick={loadRules} className="px-2 py-1 bg-gray-700 rounded text-xs"><Icon name="refresh" className="w-3 h-3" /></button>
                                        <button onClick={addRule} className="px-2 py-1 bg-green-600 rounded text-xs flex items-center gap-1"><Icon name="plus" className="w-3 h-3" />Nueva</button>
                                        <button onClick={saveRules} className="px-2 py-1 bg-purple-600 rounded text-xs flex items-center gap-1"><Icon name="check" className="w-3 h-3" />Guardar</button>
                                    </div>
                                </div>
                                <input type="text" value={ruleSearchFilter} onChange={(e) => setRuleSearchFilter(e.target.value)} placeholder="Buscar..." className="w-full px-2 py-1 mb-2 bg-gray-800 border border-gray-700 rounded text-xs" />
                                <div className="flex-1 overflow-y-auto space-y-2">
                                    {filteredRules.map((rule, ri) => {
                                        const ai = rules.indexOf(rule);
                                        return (
                                            <div key={ai} className="p-2 bg-gray-800/50 border border-gray-700/50 rounded text-xs">
                                                <div className="flex gap-2">
                                                    <div className="flex-1 space-y-2">
                                                        <div>
                                                            <div className="flex justify-between items-center mb-1"><span className="text-yellow-400 font-semibold">📁 Archivos ({rule.files.length})</span><div className="flex gap-1"><button onClick={() => addFileToRule(ai)} className="px-1 bg-green-600 rounded">+</button><button onClick={() => openFileBrowserForRule(ai)} className="px-1 bg-yellow-600 rounded"><Icon name="search" className="w-3 h-3" /></button></div></div>
                                                            {rule.files.map((f, fi) => (<div key={fi} className="flex gap-1 mb-1"><input type="text" value={f} onChange={(e) => updateFileInRule(ai, fi, e.target.value)} className="flex-1 px-2 py-1 bg-gray-900 border border-gray-600 rounded" placeholder="nombre.tap" /><button onClick={() => removeFileFromRule(ai, fi)} className="px-1 bg-red-600 rounded"><Icon name="x" className="w-3 h-3" /></button></div>))}
                                                        </div>
                                                        <div>
                                                            <div className="flex justify-between items-center mb-1"><span className="text-cyan-400 font-semibold">📂 Destinos ({rule.categories.length})</span><div className="flex gap-1"><button onClick={() => addCategoryToRule(ai)} className="px-1 bg-green-600 rounded">+</button><button onClick={() => openFolderBrowser(ai)} className="px-1 bg-cyan-600 rounded"><Icon name="folder" className="w-3 h-3" /></button></div></div>
                                                            {rule.categories.map((c, ci) => (<div key={ci} className="flex gap-1 mb-1 items-center"><span className={`px-1.5 py-0.5 rounded font-bold ${c.startsWith('FE:') ? 'bg-blue-600' : c.startsWith('TS:') ? 'bg-cyan-600' : 'bg-gray-600'}`}>{c.startsWith('FE:') ? 'FE' : c.startsWith('TS:') ? 'TS' : '??'}</span><input type="text" value={c} onChange={(e) => updateCategoryInRule(ai, ci, e.target.value)} className="flex-1 px-2 py-1 bg-gray-900 border border-gray-600 rounded" placeholder="FE:04 SELECCIONES/..." /><button onClick={() => removeCategoryFromRule(ai, ci)} className="px-1 bg-red-600 rounded"><Icon name="x" className="w-3 h-3" /></button></div>))}
                                                        </div>
                                                    </div>
                                                    <button onClick={() => deleteRule(ai)} className="px-2 py-1 bg-red-600 rounded h-fit"><Icon name="trash" className="w-3 h-3" /></button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {activeTab === 'log' && (
                            <div className="h-full overflow-auto bg-black/30 border border-purple-500/30 rounded p-3">
                                <div className="flex justify-between items-center mb-3">
                                    <h2 className="font-bold">📋 Log de copias ({copyLog.length})</h2>
                                    <button onClick={() => setCopyLog([])} className="px-2 py-1 bg-red-600 rounded text-xs">Limpiar</button>
                                </div>
                                {copyLog.length === 0 ? <div className="text-center text-gray-500 py-8">Arrastra archivos entre FE y TS para copiarlos</div>
                                : <div className="space-y-1">{copyLog.map((l, i) => (
                                    <div key={i} className="p-2 bg-gray-800/50 border border-gray-700/50 rounded text-xs flex items-center gap-3">
                                        <span className="text-gray-500">{l.time}</span>
                                        <span className={`px-1.5 py-0.5 rounded font-bold ${l.from === 'FE' ? 'bg-blue-600' : 'bg-cyan-600'}`}>{l.from}</span>
                                        <span className="text-gray-400">→</span>
                                        <span className={`px-1.5 py-0.5 rounded font-bold ${l.to === 'FE' ? 'bg-blue-600' : 'bg-cyan-600'}`}>{l.to}</span>
                                        <span className="text-green-400 flex-1 truncate">{l.file}</span>
                                        <span className="text-gray-400 truncate max-w-xs">/{l.dest}</span>
                                    </div>
                                ))}</div>}
                            </div>
                        )}
                    </div>

                    {/* MODALES */}
                    {showProcessModal && selectedFile && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-gray-900 border border-purple-500/30 rounded max-w-2xl w-full max-h-[70vh] flex flex-col">
                                <div className="p-3 border-b border-purple-500/20 flex justify-between"><div><h3 className="font-bold text-cyan-400 text-sm">Procesar</h3><p className="text-xs text-gray-400 truncate max-w-md">{selectedFile.name}</p></div><button onClick={() => setShowProcessModal(false)}><Icon name="x" className="w-4 h-4" /></button></div>
                                <div className="flex-1 overflow-y-auto p-3 space-y-3">
                                    {['FE', 'TS'].map(col => (<div key={col} className="border border-gray-700 rounded p-2"><h4 className={`font-semibold text-xs mb-1 ${col === 'FE' ? 'text-blue-400' : 'text-cyan-400'}`}>{col}</h4><div className="space-y-0.5 max-h-28 overflow-y-auto">{selectedFile.suggested_paths?.[col]?.map((p, i) => (<label key={i} className="flex items-start gap-2 p-1 hover:bg-gray-800 rounded text-xs cursor-pointer"><input type="checkbox" checked={selectedDestinations[col]?.includes(p)} onChange={() => toggleDestination(col, p)} className="mt-0.5" /><span className="break-all">{p}</span></label>))}</div></div>))}
                                </div>
                                <div className="p-3 border-t border-purple-500/20 flex justify-end gap-2"><button onClick={() => setShowProcessModal(false)} className="px-3 py-1 bg-gray-700 rounded text-xs">Cancelar</button><button onClick={processFile} disabled={processing} className="px-3 py-1 bg-green-600 rounded text-xs">{processing ? 'Copiando...' : 'Copiar'}</button></div>
                            </div>
                        </div>
                    )}

                    {showFolderBrowser && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-gray-900 border border-purple-500/30 rounded max-w-xl w-full max-h-[60vh] flex flex-col">
                                <div className="p-3 border-b border-purple-500/20"><div className="flex justify-between mb-2"><h3 className="font-bold text-cyan-400 text-sm">Seleccionar destino</h3><button onClick={() => setShowFolderBrowser(false)}><Icon name="x" className="w-4 h-4" /></button></div><div className="flex gap-1">{['FE', 'TS'].map(c => (<button key={c} onClick={() => { setBrowserCollection(c); setBrowserPath([]); loadBrowserFolders(c, ''); }} className={`px-2 py-1 rounded text-xs ${browserCollection === c ? (c === 'FE' ? 'bg-blue-600' : 'bg-cyan-600') : 'bg-gray-700'}`}>{c}</button>))}</div></div>
                                <div className="px-3 py-1 bg-gray-800/50 border-b border-gray-700 text-xs"><span className={browserCollection === 'FE' ? 'text-blue-400 font-bold' : 'text-cyan-400 font-bold'}>{browserCollection}:</span><button onClick={() => { setBrowserPath([]); loadBrowserFolders(browserCollection, ''); }} className="text-purple-400 ml-1">/</button>{browserPath.map((s, i) => (<React.Fragment key={i}><button onClick={() => { const np = browserPath.slice(0, i+1); setBrowserPath(np); loadBrowserFolders(browserCollection, np.join('/')); }} className="text-purple-400">{s}/</button></React.Fragment>))}</div>
                                <div className="flex-1 overflow-y-auto p-2 space-y-1">{browserFolders.map((f, i) => (<button key={i} onClick={() => { setBrowserPath([...browserPath, f.name]); loadBrowserFolders(browserCollection, [...browserPath, f.name].join('/')); }} className="w-full p-2 bg-gray-800/50 border border-gray-700/50 rounded hover:border-purple-500/50 text-left text-xs flex items-center gap-2"><Icon name="folder" className="w-3 h-3 text-cyan-400" /><span className="truncate">{f.name}</span>{f.has_subfolders && <span className="text-gray-500 ml-auto">→</span>}</button>))}</div>
                                <div className="p-3 border-t border-purple-500/20 flex justify-between items-center"><span className="text-xs text-gray-300 font-mono bg-gray-800 px-2 py-1 rounded truncate max-w-xs">{browserCollection}:{browserPath.join('/')}</span><div className="flex gap-1"><button onClick={() => setShowFolderBrowser(false)} className="px-2 py-1 bg-gray-700 rounded text-xs">Cancelar</button><button onClick={selectFolderForRule} className="px-2 py-1 bg-green-600 rounded text-xs">Seleccionar</button></div></div>
                            </div>
                        </div>
                    )}

                    {showFileBrowser && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-gray-900 border border-yellow-500/30 rounded max-w-xl w-full max-h-[60vh] flex flex-col">
                                <div className="p-3 border-b border-yellow-500/20"><div className="flex justify-between mb-2"><h3 className="font-bold text-yellow-400 text-sm">Seleccionar archivo</h3><button onClick={() => setShowFileBrowser(false)}><Icon name="x" className="w-4 h-4" /></button></div><div className="flex gap-1 mb-2">{['TEMP', 'FE', 'TS'].map(c => (<button key={c} onClick={() => { setFileBrowserCollection(c); setFileBrowserPath([]); loadFileBrowserContents(c, []); }} className={`px-2 py-1 rounded text-xs ${fileBrowserCollection === c ? 'bg-yellow-600' : 'bg-gray-700'}`}>{c}</button>))}</div><input type="text" value={fileSearchFilter} onChange={(e) => setFileSearchFilter(e.target.value)} placeholder="Filtrar..." className="w-full px-2 py-1 bg-gray-800 border border-gray-700 rounded text-xs" /></div>
                                <div className="flex-1 overflow-y-auto p-2 space-y-1">{fileBrowserItems.filter(it => !fileSearchFilter || it.name.toLowerCase().includes(fileSearchFilter.toLowerCase())).map((item, i) => (<button key={i} onClick={() => item.type === 'file' ? selectFileForRule(item) : (() => { setFileBrowserPath([...fileBrowserPath, item.name]); loadFileBrowserContents(fileBrowserCollection, [...fileBrowserPath, item.name]); })()} className="w-full p-2 bg-gray-800/50 border border-gray-700/50 rounded hover:border-yellow-500/50 text-left text-xs flex items-center gap-2"><Icon name={item.type === 'folder' ? 'folder' : 'file'} className={`w-3 h-3 ${item.type === 'folder' ? 'text-cyan-400' : 'text-yellow-400'}`} /><span className="truncate flex-1">{item.name}</span></button>))}</div>
                                <div className="p-3 border-t border-yellow-500/20 flex justify-end"><button onClick={() => setShowFileBrowser(false)} className="px-2 py-1 bg-gray-700 rounded text-xs">Cancelar</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>